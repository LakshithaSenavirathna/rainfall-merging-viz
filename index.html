<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainfall Data Blending System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #1f2937; background: #f3f4f6; }
        .navbar { background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .nav-container { max-width: 1400px; margin: 0 auto; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .nav-brand h1 { font-size: 1.5rem; color: #3b82f6; }
        .nav-brand p { font-size: 0.85rem; color: #6b7280; }
        .nav-links { display: flex; gap: 1rem; flex-wrap: wrap; }
        .nav-link { text-decoration: none; color: #1f2937; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: all 0.3s; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: #3b82f6; color: #fff; }
        .hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 4rem 2rem; text-align: center; }
        .hero-title { font-size: 3rem; margin-bottom: 1rem; }
        .hero-subtitle { font-size: 1.3rem; margin-bottom: 2rem; }
        .hero-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 2rem; margin-top: 3rem; max-width: 1200px; margin-left: auto; margin-right: auto; }
        .stat-item { background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 1rem; transition: transform 0.3s; }
        .stat-item:hover { transform: translateY(-5px) scale(1.05); }
        .stat-number { font-size: 2.5rem; font-weight: bold; }
        .stat-label { font-size: 0.95rem; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .content-section { background: #fff; border-radius: 1rem; padding: 3rem; margin-bottom: 3rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .section-header { margin-bottom: 2rem; border-left: 4px solid #3b82f6; padding-left: 1.5rem; }
        .section-number { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; width: 3rem; height: 3rem; border-radius: 50%; text-align: center; line-height: 3rem; font-weight: bold; margin-bottom: 1rem; font-size: 1.3rem; }
        .section-header h2 { font-size: 2rem; color: #1f2937; margin-bottom: 0.5rem; }
        .section-subtitle { color: #6b7280; font-size: 1.1rem; }
        .explanation-box { background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; border-left: 4px solid #3b82f6; }
        .explanation-box h3 { color: #3b82f6; margin-bottom: 1rem; font-size: 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
        .info-card { background: #fff; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .info-card h4 { color: #8b5cf6; margin-bottom: 1rem; font-size: 1.2rem; }
        .info-card ul { list-style-position: inside; line-height: 1.9; }
        .weight-visual { display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 2rem 0; flex-wrap: wrap; }
        .weight-item { padding: 1.5rem; border-radius: 1rem; text-align: center; min-width: 150px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: #fff; }
        .weight-land { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .weight-buffer { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .weight-ocean { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .weight-value { font-size: 2rem; font-weight: bold; }
        .weight-arrow { font-size: 2rem; color: #6b7280; }
        .note-box { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; padding: 1.5rem; border-radius: 0.5rem; margin-top: 1.5rem; }
        .flowchart-container { background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; border: 2px dashed #d1d5db; }
        .flowchart { background: #fff; border-radius: 0.75rem; padding: 2rem; display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .flow-item { padding: 1rem 1.5rem; border-radius: 0.75rem; text-align: center; font-weight: 500; max-width: 400px; }
        .flow-start, .flow-end { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: bold; }
        .flow-process { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .flow-decision { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; border-radius: 50%; width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; }
        .flow-arrow { font-size: 2rem; color: #6b7280; }
        .flow-branch { display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap; }
        .flow-path { display: flex; flex-direction: column; align-items: center; min-width: 250px; }
        .flow-label { background: #ef4444; color: white; padding: 0.3rem 1rem; border-radius: 1rem; font-weight: bold; font-size: 0.9rem; }
        .flow-path:nth-child(2) .flow-label { background: #10b981; }
        .performance-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin: 1.5rem 0; }
        .perf-item { background: #fff; padding: 1.5rem; border-radius: 0.75rem; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .perf-item.highlight { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .perf-label { font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem; }
        .perf-item.highlight .perf-label { color: rgba(255,255,255,0.9); }
        .perf-value { font-size: 1.8rem; font-weight: bold; color: #3b82f6; }
        .perf-item.highlight .perf-value { color: #fff; }
        .cressman-passes { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .pass-card { border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .pass-header { padding: 1rem; color: #fff; font-weight: bold; text-align: center; }
        .pass-1 .pass-header { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .pass-2 .pass-header { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
        .pass-3 .pass-header { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .pass-body { padding: 1.5rem; background: #fff; }
        .pass-body strong { display: block; margin-bottom: 0.5rem; }
        .formula-box { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border-radius: 1rem; padding: 2rem; margin: 2rem 0; text-align: center; border: 2px solid #8b5cf6; }
        .formula { font-size: 2rem; font-weight: bold; margin: 1rem 0; font-family: 'Courier New', monospace; }
        .dataset-structure { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .ds-item { background: #fff; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .ds-item strong { display: block; color: #3b82f6; margin-bottom: 1rem; }
        .ds-values { display: flex; flex-direction: column; gap: 0.5rem; }
        .ds-values span { background: #f3f4f6; padding: 0.5rem 1rem; border-radius: 0.5rem; font-family: 'Courier New', monospace; }
        .code-block { background: #1e293b; border-radius: 1rem; overflow: hidden; margin-top: 2rem; }
        .code-header { background: #0f172a; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .code-header span { color: #10b981; font-weight: bold; }
        .copy-btn { background: #3b82f6; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
        .copy-btn:hover { background: #2563eb; }
        .code-block pre { padding: 1.5rem; overflow-x: auto; }
        .code-block code { color: #e2e8f0; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.6; }
        .footer { background: #1f2937; color: #fff; padding: 2rem; text-align: center; margin-top: 4rem; }
        .scroll-to-top { position: fixed; bottom: 2rem; right: 2rem; width: 3rem; height: 3rem; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; font-size: 1.5rem; cursor: pointer; display: none; z-index: 999; }
        @media (max-width: 768px) {
            .hero-title { font-size: 2rem; }
            .content-section { padding: 2rem 1.5rem; }
            .nav-container { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>üåßÔ∏è Rainfall Data Blending</h1>
                <p>Cressman Objective Analysis System</p>
            </div>
            <div class="nav-links">
                <a href="#section1" class="nav-link active">Setup</a>
                <a href="#section2" class="nav-link">Land Mask</a>
                <a href="#section3" class="nav-link">Distance</a>
                <a href="#section4" class="nav-link">Merging</a>
                <a href="#section5" class="nav-link">Output</a>
            </div>
        </div>
    </nav>

    <header class="hero">
        <div class="hero-content">
            <h1 class="hero-title">Satellite-Station Rainfall Data Blending</h1>
            <p class="hero-subtitle">Multi-scale Cressman Objective Analysis for High-Resolution Precipitation Mapping</p>
            <div class="hero-stats">
                <div class="stat-item">
                    <div class="stat-number">5</div>
                    <div class="stat-label">Processing Stages</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">40K</div>
                    <div class="stat-label">Grid Points</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">31</div>
                    <div class="stat-label">Days Processed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">5km</div>
                    <div class="stat-label">Resolution</div>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <section id="section1" class="content-section">
            <div class="section-header">
                <span class="section-number">01</span>
                <h2>Imports and Initial Configuration</h2>
                <p class="section-subtitle">Setting up the processing environment</p>
            </div>
            
            <div class="explanation-box">
                <h3>üìã Brief Explanation</h3>
                <p><strong>Purpose:</strong> This section sets up the entire processing environment by importing necessary libraries and defining the spatial domain and file paths for the rainfall data blending system.</p>
                
                <div class="grid-2">
                    <div class="info-card">
                        <h4>üîß What It Does:</h4>
                        <ul>
                            <li>Imports 9 essential Python libraries</li>
                            <li>Sets file paths for input/output data</li>
                            <li>Defines spatial domain (2¬∞-12¬∞N, 76¬∞-86¬∞E)</li>
                            <li>Sets resolution to 0.05¬∞ (~5km)</li>
                            <li>Creates target grid (200√ó200 points)</li>
                        </ul>
                    </div>
                    <div class="info-card">
                        <h4>üì¶ Key Components:</h4>
                        <ul>
                            <li><strong>xarray:</strong> Handle NetCDF satellite data</li>
                            <li><strong>pandas:</strong> Process station CSV files</li>
                            <li><strong>numpy:</strong> Numerical computations</li>
                            <li><strong>scipy:</strong> Interpolation & distances</li>
                            <li><strong>geopandas:</strong> Geographic operations</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="flowchart-container">
                <h3>üîÑ Processing Flow</h3>
                <div class="flowchart">
                    <div class="flow-item flow-start">START</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Import Libraries<br><small>xarray, pandas, numpy, scipy, geopandas</small></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Define File Paths<br><small>Station, shapefile, output directories</small></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Define Spatial Domain<br><small>2¬∞-12¬∞N, 76¬∞-86¬∞E, 0.05¬∞ resolution</small></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Create Target Grid<br><small>200 √ó 200 points (40,000 total)</small></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-end">Grid Ready</div>
                </div>
            </div>

            <div class="code-block">
                <div class="code-header">
                    <span>üíª Code Section</span>
                    <button class="copy-btn" onclick="copyCode('code1')">Copy</button>
                </div>
                <pre id="code1"><code>import xarray as xr
import pandas as pd
import numpy as np
from scipy.interpolate import griddata
from scipy.ndimage import distance_transform_edt
import os, sys
import geopandas as gpd
from shapely.geometry import Point

station_file = '/content/Jan_2025_stationRF.csv'
shp_file = '/content/SL_district.shp'
output_dir = '/content/data'
os.makedirs(output_dir, exist_ok=True)

min_lat, max_lat = 2, 12
min_lon, max_lon = 76, 86
target_res = 0.05

target_lats = np.arange(min_lat, max_lat + target_res / 2, target_res)
target_lons = np.arange(min_lon, max_lon + target_res / 2, target_res)
target_lon, target_lat = np.meshgrid(target_lons, target_lats)</code></pre>
            </div>
        </section>

        <section id="section2" class="content-section">
            <div class="section-header">
                <span class="section-number">02</span>
                <h2>Land Mask and Weight Map Generation</h2>
                <p class="section-subtitle">Creating coastal buffer zones for smooth data blending</p>
            </div>





            
<section id="section-map" class="min-h-screen bg-gradient-to-br from-blue-100 to-blue-200 p-8">
        <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8 text-center">
            <h1 class="text-4xl font-bold text-blue-900 mb-8">Generated Weight Map</h1>
            <p class="text-gray-600 mb-8">Visualization of the land mask and the coastal buffer zone.</p>
            
            <div class="bg-gray-100 p-4 rounded-xl shadow-inner inline-block mx-auto">
                <img src="data/img.png" alt="Generated Sri Lanka Weight Map" style="width: 500px; height: auto;" class="rounded-lg shadow-md mx-auto">
            </div>
            
            <div class="mt-6 text-sm text-gray-500">
                <p>Green = Land (1.0), Fade = Buffer (0.7-0.3), Blue = Ocean (0.0)</p>
            </div>
        </div>
    </section>



            
            
            <div class="explanation-box">
                <h3>üìã Brief Explanation</h3>
                <p><strong>Purpose:</strong> Creates a sophisticated land mask identifying land vs ocean grid points and generates a weight map with coastal buffer zones for smooth blending.</p>
                
                <div class="weight-visual">
                    <div class="weight-item weight-land">
                        <div class="weight-value">1.0</div>
                        <div class="weight-label">Land</div>
                    </div>
                    <div class="weight-arrow">‚Üí</div>
                    <div class="weight-item weight-buffer">
                        <div class="weight-value">0.7‚Üí0.3</div>
                        <div class="weight-label">Buffer (15km)</div>
                    </div>
                    <div class="weight-arrow">‚Üí</div>
                    <div class="weight-item weight-ocean">
                        <div class="weight-value">0.0</div>
                        <div class="weight-label">Ocean</div>
                    </div>
                </div>

                <div class="note-box">
                    <strong>üí° Why a Buffer Zone?</strong> Without a buffer, there would be a sharp discontinuity at the coastline. The buffer creates a smooth transition, preventing artificial edges.
                </div>
            </div>

            <div class="flowchart-container">
                <h3>üîÑ Processing Flow</h3>
                <div class="flowchart">
                    <div class="flow-item flow-start">START</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Load Shapefile</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-decision">Mask File<br>Exists?</div>
                    <div class="flow-branch">
                        <div class="flow-path">
                            <div class="flow-label">NO</div>
                            <div class="flow-arrow">‚Üì</div>
                            <div class="flow-item flow-process">Create Mask<br><small>Check 40K points</small></div>
                            <div class="flow-arrow">‚Üì</div>
                            <div class="flow-item flow-process">Apply Buffer<br><small>15km gradient</small></div>
                        </div>
                        <div class="flow-path">
                            <div class="flow-label">YES</div>
                            <div class="flow-arrow">‚Üì</div>
                            <div class="flow-item flow-process">Load Mask</div>
                        </div>
                    </div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-end">Weight Map Ready</div>
                </div>
            </div>

            <div class="code-block">
                <div class="code-header">
                    <span>üíª Code Section</span>
                    <button class="copy-btn" onclick="copyCode('code2')">Copy</button>
                </div>
                <pre id="code2"><code>gdf = gpd.read_file(shp_file)
sl_geometry = gdf.union_all()

if os.path.exists(mask_file):
    ds = xr.open_dataset(mask_file)
    weight_map = ds['weight_map'].values
    ds.close()
else:
    land_mask = np.zeros_like(target_lat, dtype=bool)
    for i in range(target_lat.shape[0]):
        for j in range(target_lat.shape[1]):
            point = Point(target_lon[i, j], target_lat[i, j])
            land_mask[i, j] = sl_geometry.contains(point)
    
    dist_to_land = distance_transform_edt(~land_mask)
    weight_map = np.ones_like(target_lat, dtype=float)
    in_buffer = (dist_to_land > 0) & (dist_to_land <= 3)
    if np.any(in_buffer):
        normalized_dist = dist_to_land[in_buffer] / 3
        weight_map[in_buffer] = 0.7 - normalized_dist * 0.4
    weight_map[~land_mask & ~in_buffer] = 0</code></pre>
            </div>
        </section>

        <section id="section3" class="content-section">
            <div class="section-header">
                <span class="section-number">03</span>
                <h2>Station Data Loading and Distance Precomputation</h2>
                <p class="section-subtitle">Optimizing performance through strategic distance caching</p>
            </div>


<svg viewBox="0 0 800 550" xmlns="http://www.w3.org/2000/svg"> <defs> <linearGradient id="gridGradient" x1="0%" y1="0%" x2="100%" y2="100%"> <stop offset="0%" style="stop-color:#e0f2fe;stop-opacity:0.9" /> <stop offset="100%" style="stop-color:#bae6fd;stop-opacity:0.9" /> </linearGradient> <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"> <polygon points="0 0, 10 3.5, 0 7" fill="#dc2626" /> </marker> </defs>

<text x="350" y="480" font-size="14" font-weight="bold" fill="#475569">Longitude Grid Index (j)</text> <text x="30" y="250" font-size="14" font-weight="bold" fill="#475569" transform="rotate(-90 30,250)">Latitude Grid Index (i)</text> <text x="700" y="250" font-size="14" font-weight="bold" fill="#475569" transform="rotate(90 700,250)">Station Index (k)</text>

<g transform="translate(150, 50)" opacity="0.5"> <rect x="0" y="0" width="400" height="400" fill="#ddd" stroke="#999" stroke-width="2" stroke-dasharray="5,5"/> <text x="200" y="-20" text-anchor="middle" font-weight="bold" fill="#666">Slice k = N-1 (Last Station)</text> </g>

<g transform="translate(100, 100)"> <rect x="0" y="0" width="400" height="400" fill="#cbd5e1" stroke="#64748b" stroke-width="3"/> <text x="410" y="200" font-weight="bold" fill="#dc2626">Slice k (Current Station)</text> <circle cx="300" cy="120" r="8" fill="#dc2626" stroke="white" stroke-width="2"/> <text x="315" y="125" font-size="12" font-weight="bold" fill="#dc2626">Station k Location</text> <text x="315" y="140" font-size="10" fill="#dc2626">(station_lats_all[k], station_lons_all[k])</text> </g>

<g transform="translate(50, 150)"> <rect x="0" y="0" width="400" height="400" fill="url(#gridGradient)" stroke="#0369a1" stroke-width="4"/> <text x="200" y="-20" text-anchor="middle" font-weight="bold" fill="#0369a1">Front View: Target Grid (Slice k=0)</text>

 <path d="M 180 50 Q 220 80 230 120 Q 250 180 240 250 Q 220 320 180 350 Q 140 320 120 250 Q 110 180 130 120 Q 140 80 180 50 Z" fill="none" stroke="#0284c7" stroke-width="2" opacity="0.6"/>

 <line x1="50" y1="0" x2="50" y2="400" stroke="#0ea5e9" opacity="0.3"/>
 <line x1="150" y1="0" x2="150" y2="400" stroke="#0ea5e9" opacity="0.3"/>
 <line x1="250" y1="0" x2="250" y2="400" stroke="#0ea5e9" opacity="0.3"/>
 <line x1="350" y1="0" x2="350" y2="400" stroke="#0ea5e9" opacity="0.3"/>
 <line x1="0" y1="50" x2="400" y2="50" stroke="#0ea5e9" opacity="0.3"/>
 <line x1="0" y1="150" x2="400" y2="150" stroke="#0ea5e9" opacity="0.3"/>
 <line x1="0" y1="250" x2="400" y2="250" stroke="#0ea5e9" opacity="0.3"/>
 <line x1="0" y1="350" x2="400" y2="350" stroke="#0ea5e9" opacity="0.3"/>

 <circle cx="150" cy="250" r="8" fill="#0369a1" stroke="white" stroke-width="2"/>
 <text x="165" y="255" font-size="12" font-weight="bold" fill="#0369a1">Grid Point (i, j)</text>
 <text x="165" y="270" font-size="10" fill="#0369a1">(target_lat[i,j], target_lon[i,j])</text>
</g>

<line x1="50" y1="150" x2="200" y2="50" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5"/> <line x1="450" y1="150" x2="600" y2="50" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5"/> <line x1="450" y1="550" x2="600" y2="450" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5"/> <line x1="200" y1="400" x2="400" y2="220" stroke="#dc2626" stroke-width="4" marker-end="url(#arrowhead)"/>

<rect x="260" y="280" width="180" height="60" fill="white" stroke="#dc2626" rx="5"/> <text x="350" y="305" text-anchor="middle" font-size="11" font-weight="bold" fill="#dc2626">Calculation at dist_array[i, j, k]</text> <text x="350" y="325" text-anchor="middle" font-size="10" font-style="italic" fill="#333">sqrt((lat_st - lat_grid)¬≤ + (lon_st - lon_grid)¬≤)</text>

</svg>
            
            
            <div class="explanation-box">
                <h3>üìã Brief Explanation</h3>
                <p><strong>Purpose:</strong> Loads station data, filters within domain, and precomputes distances from every grid point to every station.</p>
                
                <div class="performance-stats">
                    <div class="perf-item">
                        <div class="perf-label">Array Size</div>
                        <div class="perf-value">200√ó200√óN</div>
                    </div>
                    <div class="perf-item">
                        <div class="perf-label">Computations</div>
                        <div class="perf-value">40K√óN</div>
                    </div>
                    <div class="perf-item highlight">
                        <div class="perf-label">Time Saved</div>
                        <div class="perf-value">97%</div>
                    </div>
                </div>

                <div class="note-box">
                    <strong>üí° Why Precompute?</strong> For 50 stations √ó 31 days, precomputation saves ~60 million distance calculations!
                </div>
            </div>

            <div class="flowchart-container">
                <h3>üîÑ Processing Flow</h3>
                <div class="flowchart">
                    <div class="flow-item flow-start">START</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Load Station CSV</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Filter Stations</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-decision">Distance File<br>Exists?</div>
                    <div class="flow-branch">
                        <div class="flow-path">
                            <div class="flow-label">NO</div>
                            <div class="flow-arrow">‚Üì</div>
                            <div class="flow-item flow-process">Calculate Distances<br><small>40K √ó N stations</small></div>
                            <div class="flow-arrow">‚Üì</div>
                            <div class="flow-item flow-process">Save to Disk</div>
                        </div>
                        <div class="flow-path">
                            <div class="flow-label">YES</div>
                            <div class="flow-arrow">‚Üì</div>
                            <div class="flow-item flow-process">Load Distances</div>
                        </div>
                    </div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-end">Distance Array Ready</div>
                </div>
            </div>

            <div class="code-block">
                <div class="code-header">
                    <span>üíª Code Section</span>
                    <button class="copy-btn" onclick="copyCode('code3')">Copy</button>
                </div>
                <pre id="code3"><code>df_station = pd.read_csv(station_file)
df_station = df_station[(df_station['latitude'] >= min_lat) & 
                        (df_station['latitude'] <= max_lat) &
                        (df_station['longitude'] >= min_lon) & 
                        (df_station['longitude'] <= max_lon)]

station_lats_all = df_station['latitude'].values
station_lons_all = df_station['longitude'].values
num_stations = len(station_lats_all)

if os.path.exists(dist_file):
    dist_array = np.load(dist_file)
else:
    dist_array = np.zeros((target_lat.shape[0], target_lat.shape[1], num_stations))
    for i in range(target_lat.shape[0]):
        for j in range(target_lat.shape[1]):
            dist_array[i, j, :] = np.sqrt(
                (station_lats_all - target_lat[i, j])**2 + 
                (station_lons_all - target_lon[i, j])**2
            )
    np.save(dist_file, dist_array)</code></pre>
            </div>
        </section>

        <section id="section4" class="content-section">
            <div class="section-header">
                <span class="section-number">04</span>
                <h2>Main Daily Merging Loop</h2>
                <p class="section-subtitle">Iterative Cressman objective analysis for 31 days</p>
            </div>
            
            <div class="explanation-box">
                <h3>üìã Brief Explanation</h3>
                <p><strong>Purpose:</strong> For each of 31 days, loads satellite data, interpolates to target grid, then uses Cressman successive correction with station observations.</p>
                
                <div class="cressman-passes">
                    <div class="pass-card pass-1">
                        <div class="pass-header">Pass 1: r = 0.5¬∞</div>
                        <div class="pass-body">
                            <strong>Regional Patterns</strong>
                            <p>Large radius (~55km) captures broad corrections</p>
                        </div>
                    </div>
                    <div class="pass-card pass-2">
                        <div class="pass-header">Pass 2: r = 0.3¬∞</div>
                        <div class="pass-body">
                            <strong>Mesoscale Features</strong>
                            <p>Medium radius (~33km) refines patterns</p>
                        </div>
                    </div>
                    <div class="pass-card pass-3">
                        <div class="pass-header">Pass 3: r = 0.1¬∞</div>
                        <div class="pass-body">
                            <strong>Local Details</strong>
                            <p>Small radius (~11km) fine-tunes locally</p>
                        </div>
                    </div>
                </div>

                <div class="formula-box">
                    <h4>Cressman Weight Function</h4>
                    <div class="formula">w = (r¬≤ - d¬≤) / (r¬≤ + d¬≤)</div>
                    <p>where <strong>w</strong> = weight, <strong>r</strong> = radius, <strong>d</strong> = distance</p>
                </div>
            </div>

            <div class="flowchart-container">
                <h3>üîÑ Processing Flow</h3>
                <div class="flowchart">
                    <div class="flow-item flow-start">START DAY LOOP (1-31)</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Load Satellite NetCDF</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Interpolate to 5km Grid<br><small>Cubic spline</small></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Load Station Data</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">CRESSMAN LOOP<br><small>3 passes: r = 0.5, 0.3, 0.1¬∞</small></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Compute Residuals<br><small>station - grid</small></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Apply Cressman Weights</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Apply Buffer Weights</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Update Grid</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-end">Next Day (Loop 31x)</div>
                </div>
            </div>

            <div class="code-block">
                <div class="code-header">
                    <span>üíª Code Section</span>
                    <button class="copy-btn" onclick="copyCode('code4')">Copy</button>
                </div>
                <pre id="code4"><code>days = range(1, 32)
merged_list = []

for day in days:
    satellite_file = f'gpm_data/3B-DAY-L.MS.MRG.3IMERG.202501{day:02d}.nc4'
    ds_sat = xr.open_dataset(satellite_file)
    
    initial_guess = griddata(
        (sat_lat_mesh.ravel(), sat_lon_mesh.ravel()), 
        sat_precip.ravel(),
        (target_lat, target_lon), 
        method='cubic'
    )
    
    merged_precip = initial_guess.copy()
    radii = [0.5, 0.3, 0.1]
    
    for r in radii:
        current_at_stations = griddata(
            (target_lat.ravel(), target_lon.ravel()), 
            merged_precip.ravel(),
            (station_lat, station_lon), 
            method='linear'
        )
        residuals = station_precip - current_at_stations
        
        correction_grid = np.zeros_like(merged_precip)
        in_radius = dist_array < r
        
        for i in range(target_lat.shape[0]):
            for j in range(target_lat.shape[1]):
                if np.any(in_radius[i, j, :]):
                    mask = in_radius[i, j, :]
                    weights = (r**2 - dist_array[i,j,mask]**2) / (r**2 + dist_array[i,j,mask]**2)
                    correction_grid[i, j] = np.sum(weights * residuals[mask]) / np.sum(weights)
        
        correction_grid *= weight_map
        merged_precip += correction_grid
    
    merged_precip = np.clip(merged_precip, 0, np.inf)
    merged_list.append(merged_precip)</code></pre>
            </div>
        </section>

        <section id="section5" class="content-section">
            <div class="section-header">
                <span class="section-number">05</span>
                <h2>Final Dataset Assembly and Output</h2>
                <p class="section-subtitle">Creating CF-compliant NetCDF with metadata</p>
            </div>
            
            <div class="explanation-box">
                <h3>üìã Brief Explanation</h3>
                <p><strong>Purpose:</strong> Assembles 31 daily grids into a single NetCDF file following CF conventions with comprehensive metadata.</p>
                
                <div class="dataset-structure">
                    <div class="ds-item">
                        <strong>Dimensions</strong>
                        <div class="ds-values">
                            <span>time: 31</span>
                            <span>lat: 200</span>
                            <span>lon: 200</span>
                        </div>
                    </div>
                    <div class="ds-item">
                        <strong>Format</strong>
                        <div class="ds-values">
                            <span>NetCDF4</span>
                            <span>CF-compliant</span>
                            <span>~10 MB</span>
                        </div>
                    </div>
                </div>

                <div class="note-box">
                    <strong>üí° Why CF Conventions?</strong> Ensures the file is self-describing and interoperable with standard scientific software.
                </div>
            </div>

            <div class="flowchart-container">
                <h3>üîÑ Processing Flow</h3>
                <div class="flowchart">
                    <div class="flow-item flow-start">START</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Stack Daily Grids<br><small>31 arrays ‚Üí 3D</small></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Create xarray Dataset</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Add Attributes<br><small>CF-compliant metadata</small></div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Define Encoding</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-process">Write NetCDF File</div>
                    <div class="flow-arrow">‚Üì</div>
                    <div class="flow-item flow-end">SUCCESS</div>
                </div>
            </div>

            <div class="code-block">
                <div class="code-header">
                    <span>üíª Code Section</span>
                    <button class="copy-btn" onclick="copyCode('code5')">Copy</button>
                </div>
                <pre id="code5"><code>ds_out = xr.Dataset(
    {'precip': (('time', 'lat', 'lon'), np.stack(merged_list))},
    coords={'time': ('time', timestamps), 
            'lat': ('lat', target_lats), 
            'lon': ('lon', target_lons)}
)

ds_out['lat'].attrs = {
    'units': 'degrees_north', 
    'long_name': 'latitude', 
    'standard_name': 'latitude'
}
ds_out['lon'].attrs = {
    'units': 'degrees_east', 
    'long_name': 'longitude', 
    'standard_name': 'longitude'
}
ds_out['precip'].attrs = {
    'units': 'mm/day', 
    'long_name': 'precipitation'
}

ds_out.attrs = {
    'history': 'Merged satellite and station precipitation', 
    'creation_date': '2025-01-05'
}

encoding = {
    'precip': {'_FillValue': np.nan},
    'lat': {'_FillValue': np.nan},
    'lon': {'_FillValue': np.nan}
}

ds_out.to_netcdf('data/merged_5km_precip_IMERG.nc', encoding=encoding)
print("Merged data saved successfully")</code></pre>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 Rainfall Data Blending System | Multi-scale Cressman Objective Analysis</p>
            <p>Documentation for GitHub Pages</p>
        </div>
    </footer>

    <button class="scroll-to-top" onclick="scrollToTop()">‚Üë</button>

    <script>
        function copyCode(codeId) {
            const codeElement = document.getElementById(codeId);
            const code = codeElement.textContent;
            navigator.clipboard.writeText(code).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            });
        }

        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetSection = document.querySelector(targetId);
                navLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        });

        window.addEventListener('scroll', function() {
            const scrollBtn = document.querySelector('.scroll-to-top');
            if (window.pageYOffset > 300) {
                scrollBtn.style.display = 'block';
            } else {
                scrollBtn.style.display = 'none';
            }

            const sections = document.querySelectorAll('.content-section');
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (window.pageYOffset >= sectionTop - 200) {
                    current = section.getAttribute('id');
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        console.log('üåßÔ∏è Rainfall Data Blending System loaded successfully!');
    </script>
</body>
</html>





